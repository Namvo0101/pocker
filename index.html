<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title> Đánh bài cùng Bích Ngân ^_^ </title>
<style>
  body { 
    text-align: center; 
    margin: 0; 
    padding: 0; 
  }
  #header {
    font-size: 10px; /* Downsize font */
    margin-top: 5px; 
    margin-bottom: 5px;
  }
  table { 
    margin: auto; 
    border: 1px solid black; 
    border-collapse: collapse; 
    width: 90%; /* 90% width to fit the screen */
  }
  th, td { 
    padding: 5px; 
    text-align: center; 
    box-sizing: border-box; /* Include padding in width calculation */
    word-wrap: break-word; /* Allow text to wrap within cells */
  }
  th { 
    background-color: #f2f2f2; 
  }
  input[type="number"], input[type="text"] { 
    width: 20%; /* Full width */
    box-sizing: border-box; /* Include padding in width calculation */
    text-align: center; /* Center text */
  }
  .score-positive { color: green; }
  .score-negative { color: red; }
  .score-neutral { color: grey; }
  .check-positive { color: green; }
  .check-negative { color: red; }
  .total-score { font-size: 24px; font-weight: bold; } /* Increased font size and bold */
  button {
    margin-top: 10px;
    font-size: 30px; /* Increase font size */
    padding: 10px 20px; /* Increase padding for larger buttons */
  }
  @media (max-width: 600px) {
    .total-score { font-size: 18px; } /* Adjust font size for smaller screens */
    button { font-size: 30px; padding: 8px 16px; } /* Adjust button size */
    th, td { padding: 3px; } /* Reduce padding for smaller screens */
  }

  /* Add styles for sticky header */
  #scoreTable thead, #scoreTable thead th {
    position: sticky;
    top: 0;
    background-color: #f2f2f2;
    z-index: 10;
    font-size: 30px;
  }

  /* Ensure the total score row is also sticky */
  #scoreTable tr:nth-child(2), #scoreTable tr:nth-child(2) td {
    position: sticky;
    top: 23px; /* Adjust this value based on the height of the first row */
    background-color: white;
    z-index: 5;
  }
</style>
</head>
<body>

<div id="header">------ Nam Vo ------</div>

<table id="scoreTable">
  <thead>
    <tr>
      <th></th>
      <th><input type="text" id="name-0" value="Bích Ngân" onblur="setName(0)"></th>
      <th><input type="text" id="name-1" value="Phương Nam" onblur="setName(1)"></th>
      <th><input type="text" id="name-2" value="Cẩm Lệ" onblur="setName(2)"></th>
      <th><input type="text" id="name-3" value="Nhật Nam" onblur="setName(3)"></th>
    </tr>
    <tr>
      <td></td>
      <td><span id="total-score-0" class="score-neutral total-score">0</span></td>
      <td><span id="total-score-1" class="score-neutral total-score">0</span></td>
      <td><span id="total-score-2" class="score-neutral total-score">0</span></td>
      <td><span id="total-score-3" class="score-neutral total-score">0</span></td>
    </tr>
  </thead>
  <tbody>
    <!-- The rest of your rows will go here -->
  </tbody>
</table>

<button onclick="enterPoints()">Enter Points</button>
<button onclick="completeScores()">Complete</button>
<button onclick="resetGame()">Reset</button>

<br>
<button onclick="exportExcel()">Export Excel</button>

<!-- Cách A: SheetJS (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  var STORAGE_KEY = "scoreTable_save_v1";

  function saveGame() {
    var table = document.getElementById("scoreTable");
    var data = { headers: [], rows: [] };

    // Save headers (name row): keep whether it's still an input or already turned into text
    for (var i = 0; i < 4; i++) {
      var th = table.rows[0].cells[i + 1];
      var input = th.querySelector("input");
      if (input) {
        data.headers.push({ isInput: true, value: input.value });
      } else {
        data.headers.push({ isInput: false, value: th.innerHTML });
      }
    }

    // Save all score rows + check column (start from row 2 because row 0/1 are header + totals)
    for (var r = 2; r < table.rows.length; r++) {
      var row = table.rows[r];
      var rowObj = { check: row.cells[0].innerHTML, scores: [] };
      for (var c = 1; c <= 4; c++) {
        var cellInput = row.cells[c].firstChild;
        rowObj.scores.push(cellInput ? (cellInput.value || "") : "");
      }
      data.rows.push(rowObj);
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function attachAutoSaveToExistingInputs() {
    for (var i = 0; i < 4; i++) {
      var inputs = document.getElementsByClassName("score-input-" + i);
      Array.from(inputs).forEach(function(inp) {
        inp.addEventListener("input", saveGame);
      });
    }
  }

  function loadGame() {
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;

    var data = JSON.parse(raw);
    var table = document.getElementById("scoreTable");

    // Restore headers
    for (var i = 0; i < 4; i++) {
      var th = table.rows[0].cells[i + 1];
      var h = data.headers[i];

      if (h && h.isInput) {
        th.innerHTML = '<input type="text" id="name-' + i + '" value="' + (h.value || "") + '" onblur="setName(' + i + ')">';
      } else {
        th.innerHTML = (h && h.value != null) ? h.value : th.innerHTML;
      }
    }

    // Remove existing score rows (if any)
    while (table.rows.length > 2) {
      table.deleteRow(-1);
    }

    // Restore rows
    if (data.rows && data.rows.length) {
      data.rows.forEach(function(r) {
        var row = table.insertRow(-1);
        var checkCell = row.insertCell(0);
        checkCell.innerHTML = r.check || '';

        for (var i = 1; i <= 4; i++) {
          var cell = row.insertCell(i);
          cell.innerHTML = '<input type="number" class="score-input-' + (i - 1) + '">';
          var inp = cell.firstChild;
          inp.value = (r.scores && r.scores[i - 1] != null) ? r.scores[i - 1] : "";
          inp.addEventListener("input", saveGame);
        }
      });
    }

    // Recompute totals/colors/checks exactly like before, then save current state (including O/X)
    completeScores();
    saveGame();
  }

  function resetGame() {
    if (!confirm("Bạn có chắc muốn reset để tạo game mới và xoá hết dữ liệu cũ không?")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  function setName(index) {
    var input = document.getElementById("name-" + index);
    var name = input.value;
    var th = input.parentElement;
    th.innerHTML = name;

    saveGame();
  }

  // Function to add a new row for entering points
  function enterPoints() {
    var table = document.getElementById("scoreTable");
    var row = table.insertRow(-1);
    var checkCell = row.insertCell(0); // Add check column
    checkCell.innerHTML = ''; // Empty initially
    for (var i = 1; i <= 4; i++) {
      var cell = row.insertCell(i);
      cell.innerHTML = '<input type="number" class="score-input-' + (i - 1) + '">';
      cell.firstChild.addEventListener("input", saveGame);
    }

    saveGame();
  }

  // Function to calculate the total scores and update colors
  function completeScores() {
    var totals = [0, 0, 0, 0];
    var table = document.getElementById("scoreTable");
    var rowCount = table.rows.length;
    var error = false;

    // Calculate column totals
    for (var i = 0; i < 4; i++) {
      var inputs = document.getElementsByClassName("score-input-" + i);
      totals[i] = Array.from(inputs).reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
      var totalElement = document.getElementById("total-score-" + i);
      totalElement.innerText = totals[i];
      if (totals[i] > 0) {
        totalElement.className = 'score-positive total-score';
      } else if (totals[i] < 0) {
        totalElement.className = 'score-negative total-score';
      } else {
        totalElement.className = 'score-neutral total-score';
      }
    }

    // Update check column for each row and check row totals
    for (var rowIdx = 2; rowIdx < rowCount; rowIdx++) { // Start from 2 to skip the header and total rows
      var row = table.rows[rowIdx];
      var rowSum = 0;
      for (var colIdx = 1; colIdx <= 4; colIdx++) {
        var cell = row.cells[colIdx].firstChild;
        rowSum += parseInt(cell.value) || 0;
      }
      var checkCell = row.cells[0];
      if (rowSum === 0) {
        checkCell.innerHTML = '<span class="check-positive">O</span>';
      } else {
        checkCell.innerHTML = '<span class="check-negative">X</span>';
        error = true; // Set error flag if any row sum is different from 0
      }
    }

    saveGame();

    // Display error message if any row total is different from 0
    if (error) {
      alert("Nhập sai rồi bạn êyyyy ^_^");
    }
  }

  // Export Excel (.xlsx) using SheetJS (XLSX) + add header "—— Nam Vo ——"
  function exportExcel() {
    // giữ đúng hành vi hiện tại: export dựa trên trạng thái sau khi complete
    // (nếu có dòng sai sẽ alert như cũ)
    completeScores();

    var table = document.getElementById("scoreTable");

    // Read player names (input or text, exactly as displayed)
    var names = [];
    for (var i = 0; i < 4; i++) {
      var th = table.rows[0].cells[i + 1];
      var inp = th.querySelector("input");
      names.push(inp ? inp.value : th.innerText);
    }

    // Build AOA
    var aoa = [];

    // Header in Excel (NEW)
    aoa.push(["—— Nam Vo ——"]);
    aoa.push([]); // blank row

    // Table header
    aoa.push(["", names[0], names[1], names[2], names[3], "RowSum"]);

    // Totals
    var totals = [];
    for (var i = 0; i < 4; i++) {
      totals.push(document.getElementById("total-score-" + i).innerText);
    }
    aoa.push(["TOTAL", totals[0], totals[1], totals[2], totals[3], ""]);

    // Score rows
    for (var r = 2; r < table.rows.length; r++) {
      var row = table.rows[r];
      var check = row.cells[0].innerText.trim(); // O / X (or empty)
      var vals = [];
      var sum = 0;

      for (var c = 1; c <= 4; c++) {
        var v = parseInt(row.cells[c].firstChild.value) || 0;
        vals.push(v);
        sum += v;
      }
      aoa.push([check, vals[0], vals[1], vals[2], vals[3], sum]);
    }

    var wb = XLSX.utils.book_new();
    var ws = XLSX.utils.aoa_to_sheet(aoa);

    // Optional column width (only in Excel file)
    ws["!cols"] = [{wch: 6}, {wch: 14}, {wch: 14}, {wch: 14}, {wch: 14}, {wch: 10}];

    XLSX.utils.book_append_sheet(wb, ws, "Scores");

    // Filename with timestamp
    var now = new Date();
    function pad(n) { return String(n).padStart(2, "0"); }
    var filename =
      "scores_" +
      now.getFullYear() + "-" + pad(now.getMonth() + 1) + "-" + pad(now.getDate()) + "_" +
      pad(now.getHours()) + pad(now.getMinutes()) +
      ".xlsx";

    XLSX.writeFile(wb, filename);
  }

  window.addEventListener("load", function() {
    loadGame();
    attachAutoSaveToExistingInputs();
  });

  window.addEventListener("beforeunload", saveGame);
</script>

</body>
</html>
